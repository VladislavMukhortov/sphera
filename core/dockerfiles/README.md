### docker compose -f ./oxly-docker-compose.yml up -d




# Wiki по работе с контейнреами докера

## Структура контейнеров

Все файлы необходимые для работы контейнеров хранятся в директории /srv/pr/$PROJECT_ROOT_NAMESPACE/PROJECT_NAME
В этой директории всегда есть две папки:
```
    git - папка с файлами проекта, клон с git ветки которую нужно развернуть
    docker - папка с файлами необходимыми для работы контейнеров, клон с git ветки docker
```
В папке docker всегла есть фаил $PROJECT_ROOT_NAMESPACE-$PROJECT_NAME-docker-compose.yml это фаил который запускает все необходимые для работы проекта контейнеры, и .env это фаил в котором расположены глобальные переменные необходимые для запуска контейнеров. В зависимости от проекта есть дополнительные директории с говорящими названими, в которых содержаться конфигурационные файлы сервисов которые запускаются в контейнерах.

Все контейнеры одного проекта имеют одинаковый префикс $PROJECT_ROOT_NAMESPACE-$PROJECT_NAME-*, посмотреть какие контейнеры из связки работатю а какие нет можно командой 
```
    docker ps | grep $PROJECT_ROOT_NAMESPACE-$PROJECT_NAME
```
---

## Запуск и остановка контейнеров проекта  
  

### Всегда помните, что все изменения сделанные в контейнере при перезапуске (пересоздании) удалятся, контейнер всегда запускается в виде в котором он скоомпилирован.

В связи с этим в каждом *-docker-compose.yml прописаны команды которые необходимо выполнить при запуске контейнера.

## Команда запуска контейнеров проекта 
```
    docker compose -f /srv/pr/$PROJECT_ROOT_NAMESPACE/PROJECT_NAME/$PROJECT_ROOT_NAMESPACE-$PROJECT_NAME-docker-compose.yml up -d
```
где -f - полняй путь до файла *-docker-compose.yml, up -команда создания и запуска контейнера, -d - запуск в фоне

###  Команда для остановки контейнеров проекта 
```
     docker compose -f /srv/pr/$PROJECT_ROOT_NAMESPACE/PROJECT_NAME/$PROJECT_ROOT_NAMESPACE-$PROJECT_NAME-docker-compose.yml down
```
где down - команда остановки и удаления контейнеров 

### Команда для подключения к контейнеру в интерактивном режиме
```
    docker exec -it $PROJECT_ROOT_NAMESPACE-$PROJECT_NAME-php bash
```
Где -it - интерактивный режим, bash - команда которая выполнится первой

Далее вы можете запускать любые необходимые команды.

---

### Общая структура stage сервера

Помимо контейнеров проектов задача которых выполненине кода из git, на серврере запущено ряд сервисных контейнеров на данный момент это:
```
    nginx-proxy - обратный прокси, настроенный на автоматическое добавление зон при сосздании нового контейнера с определенными переменными окружения
    nginx-proxy-acme - контейнер выпускающий сертификаты Let's Encrypt, также при наличии определенных переменных в окружении
    openssh-server - ssh сервер через который можно подключится к контейнерам по сети (имя контейнера)
```
### Переменные которые нужно определить в контейнерах проекта для вхаимодействия с сервисными контейнерами
```
    VIRTUAL_HOST: $PROJECT_ROOT_NAMESPACE-$PROJECT_NAME.y7jasha6g5cdsa.ru       - доменное имя по которому проект будет доступен, нужен для nginx-proxy
    VIRTUAL_PORT: 80                                                            - порт на котором приложение в контейнере будет отдавать информацию nginx-proxy
    LETSENCRYPT_HOST: $PROJECT_ROOT_NAMESPACE-$PROJECT_NAME.y7jasha6g5cdsa.ru   - доменное имя для сертификата выпускаемого контейнером nginx-proxy-acme
    LETSENCRYPT_EMAIL: sevismail@ya.ru                                          - электронная почта для сертификата выпускаемого контейнером nginx-proxy-acme
```
Для взаимодействия контейнреов с сервисными контейнерами нужно подключить их в сеть сервисных контейнреров, для nginx-proxy это сеть net-nginx, для openssh-server это сеть net-openssh.
